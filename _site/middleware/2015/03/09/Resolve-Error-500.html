<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title> 解决IHS/Plugin/WAS环境中请求转发失败的问题（500错误） | Leap Day in Jekyll</title>
    <link rel="stylesheet" href="assets/stylesheets/styles.css">
    <link rel="stylesheet" href="assets/stylesheets/pygment_trac.css">
    <script src="http://dellyqiao.qiniudn.com/dellyqiao.com/rsc/jquery-2.0.3.min.js"></script>
    <script src="assets/javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>

  <header>
    <a href="">
      <h1>Leap Day for Jekyll</h1>
      <p>Theme built on GitHub Pages for all to use.</p>
    </a>
  </header>


  <div id="banner">
  <div class="banner-inner">
    <span id="logo"><span class="octicon octicon-mark-github"></span></span>

    <a href="https://github.com/mattgraham/leapday" class="button fork"><strong>Fork On GitHub</strong></a>
    <div class="downloads">
      <span>Downloads:</span>
      <ul>
        <li><a href="https://github.com/mattgraham/leapday/zipball/master" class="button">ZIP</a></li>
        <li><a href="https://github.com/mattgraham/leapday/tarball/master" class="button">TAR</a></li>
      </ul>
    </div>
  </div>
</div>


  <div class="wrapper">

    <nav>
  <ul></ul>
</nav>


  <section>
    <h1>Heading One</h1>
    <p>This automatic page generator is the easiest way to create beautiful pages for all of your projects. Author your page content here using GitHub Flavored Markdown, select a template crafted by a designer, and publish. After your page is generated, you can check out the new branch:</p>

    <p><img src="http://f.cl.ly/items/1f3f0U0A3x0P1Z022y1Q/532999_10150681079447771_501672770_9454022_1744955305_n.jpeg" alt="New Haven South Beach by Matt Graham"></p>

    <pre><code>$ cd your_repo_root/repo_name
    $ git fetch origin
    $ git checkout gh-pages</code>
    </pre>

    <p>As we do, we're open sourcing the front end code for the new GitHub pages themes. This is just one of the many beautiful themes that can used to dynamically turn your static repo into a beautiful marketing site.  </p>

    <h2>Designer Templates</h2>

    <p>We've crafted some handsome templates for you to use. Go ahead and continue to layouts to browse through them. You can easily go back to edit your page before publishing. After publishing your page, you can revisit the page generator and switch to another theme. Your page content will be preserved if it remained in markdown format.</p>

    <ul>
      <li>Hack by <a href="https://github.com/bleikamp">Ben Bleikamp</a></li>
      <li>Merlot by <a href="https://github.com/cameronmcefee">Cameron McEfee</a></li>
      <li>Slate by <a href="https://github.com/jsncostello">Jason Costello</a></li>
      <li>Time Machine by <a href="https://github.com/jonrohan">Jon Rohan</a></li>
      <li>Leap Day by <a href="https://github.com/mattgraham">Matt Graham</a></li>
      <li>Midnight by <a href="https://github.com/mattgraham">Matt Graham</a></li>
      <li>Minimal by <a href="https://github.com/orderedlist">Steve Smith</a></li>
      <li>Modernist by <a href="https://github.com/orderedlist">Steve Smith</a></li>
    </ul>

    <p>For more info on GitHub Pages, check out <a href="http://pages.github.com/">pages.github.com</a>. For help, check the <a href="http://help.github.com/pages">GitHub Pages documentation</a>.</p>

    <h2>What will code look like?</h2>

    <p>Your code should be beautiful, or at least that's what the designers think. </p>

    <div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'adapter/memory'</span>
<span class="nb">require</span> <span class="s1">'toystore'</span>

<span class="k">class</span> <span class="nc">User</span>
<span class="kp">include</span> <span class="no">Toy</span><span class="o">::</span><span class="no">Store</span>
<span class="n">adapter</span> <span class="ss">:memory</span><span class="p">,</span> <span class="p">{}</span>

<span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="nb">String</span>
<span class="k">end</span>
</pre>
    </div>

    <p>So, this is what HTML Code looks like</p>

    <div class="highlight">
<pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"header"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;nav&gt;</span>
       <span class="nt">&lt;li&gt;</span>Home<span class="nt">&lt;/li&gt;</span>
       <span class="nt">&lt;li&gt;</span>About Us<span class="nt">&lt;/li&gt;</span>
       <span class="nt">&lt;li&gt;</span>Contact<span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;/nav&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre>
    </div>

    <p>And, then maybe some CSS</p>

    <div class="highlight">
<pre>
<span class="nt">body</span> <span class="p">{</span>
<span class="k">font</span><span class="o">:</span><span class=
"m">14px</span><span class="o">/</span><span class="m">22px</span> <span class=
"s1">'Quattrocento Sans'</span><span class="o">,</span> <span class=
"s2">"Helvetica Neue"</span><span class="o">,</span> <span class=
"n">Helvetica</span><span class="o">,</span> <span class=
"n">Arial</span><span class="o">,</span> <span class=
"k">sans-serif</span><span class="p">;</span>
<span class="k">color</span><span class="o">:</span><span class=
"m">#666</span><span class="p">;</span>
<span class="k">font-weight</span><span class=
"o">:</span><span class="m">300</span><span class="p">;</span>
<span class="k">margin</span><span class="o">:</span> <span class=
"m">0px</span><span class="p">;</span>
<span class="k">padding</span><span class="o">:</span><span class=
"m">0px</span> <span class="m">0</span> <span class=
"m">20px</span> <span class="m">0px</span><span class="p">;</span>
<span class="k">background</span><span class=
"o">:</span> <span class="sx">url(../images/body-background.png)</span> <span class="m">#eae6d1</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">h1</span><span class="o">,</span> <span class=
"nt">h2</span><span class="o">,</span> <span class="nt">h3</span><span class=
"o">,</span> <span class="nt">h4</span><span class="o">,</span> <span class=
"nt">h5</span><span class="o">,</span> <span class="nt">h6</span> <span class=
"p">{</span>
<span class="k">color</span><span class="o">:</span><span class=
"m">#333</span><span class="p">;</span>
<span class="k">margin</span><span class="o">:</span><span class=
"m">0</span> <span class="m">0</span> <span class="m">10px</span><span class=
"p">;</span>
<span class="p">}</span>

<span class="nt">p</span><span class="o">,</span> <span class=
"nt">ul</span><span class="o">,</span> <span class="nt">ol</span><span class=
"o">,</span> <span class="nt">table</span><span class="o">,</span> <span class=
"nt">pre</span><span class="o">,</span> <span class="nt">dl</span> <span class=
"p">{</span>
<span class="k">margin</span><span class="o">:</span><span class=
"m">0</span> <span class="m">0</span> <span class="m">20px</span><span class=
"p">;</span>
<span class="p">}</span>
</pre>
    </div>

    <p>Inline code would look a little different. <code>We want you to see</code> where it is, but its going to be a little less noticeable. It might also be as simple as <code>:hover</code> and as unique as <code>:first-child</code>. It is up to you. </p>

    <h2>Sub-Nav Questions</h2>

    <p>The sub-navigation is automatically generated using a little JS based on the H1 and H2 tags in your markdown file. The goal was to make it a quick <code>and exciting</code> way to write a markdown file and create an amazing pages site.  </p>

    <h2>Who is Matt Graham?</h2>
<p><img src="http://www.gravatar.com/avatar/25d643886852ad60d0efe0b3190a53dd.png?s=600" alt="Matt Graham"></p>
<p>A creative. Previously at GitHub, Ordered List etc. He can be found on <a href="http://twitter.com/#!/michigangraham">Twitter</a>, <a href="http://github.com/mattgraham">GitHub</a>, <a href="http://madebygraham.com">his blog</a>, and around the country for numerous events. Enjoyed the theme? Share it with the twitterverse. Found bugs, submit a pull request and he'll see what he thinks.</p>


    </section>

	<p>这几天遇到了一个IHS到WAS请求转发失败的问题，所以就打算把常见的几种错误和排错的经验写出来了。</p>

<p>文章内容仅适用于IHS和WAS分别安装在不同服务器上的情况，文章里提到的一些错误在其他情况下也许根本就不会发生。</p>

<h2 id="section">本例中环境的配置：</h2>

<p>IHS和WAS分别装在两台服务器上，两台服务器分别位于不同的DMZ，DMZ之间有防火墙，在防火墙上只开通了必要的端口。</p>

<p>在本例中，公网用户通过公网IP(public_ip)，端口80和443访问IHS服务器，IHS服务器(IP地址为：ihs_server)上安装了Plugin，plugin通过端口9081把网站的请求转发到WAS服务器(IP地址为：was_server)。假设要请求的资源在WAS服务器上，叫abc.jsp.</p>

<h2 id="section-1">出现的问题：</h2>

<p>从公网测试：</p>

<p>http://public_ip/abc.jsp — abc.jsp可以正常显示</p>

<p>https://public_ip/abc.jsp — 500 Internal Server Error</p>

<p>从IHS服务器上测试：</p>

<p>http://ihs_server/abc.jsp — abc.jsp可以正常显示</p>

<p>https://ihs_server/abc.jsp — 500 Internal Server Error</p>

<p>从IHS和WAS服务器上分别测试：</p>

<p>http://was_server:9081/abc.jsp – abc.jsp可以正常显示</p>

<h2 id="troubleshooting">Troubleshooting和问题分析</h2>

<h3 id="plugincfglog">1）首先看plugin_cfg.log，错误信息如下：</h3>

<p>```
[Wed Dec 03 15:40:13 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereGetStream: Connect timeout fired</p>

<p>[Wed Dec 03 15:40:18 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereGetStream: Connect timeout fired</p>

<p>[Wed Dec 03 15:40:18 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereExecute: Failed to create the stream</p>

<p>[Wed Dec 03 15:40:18 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereHandleRequest: Failed to execute the transaction to ‘wasserverNode01_abc’on host ‘wasserver’; will try another one</p>

<p>[Wed Dec 03 15:40:23 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereGetStream: Connect timeout fired</p>

<p>[Wed Dec 03 15:40:28 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereGetStream: Connect timeout fired</p>

<p>[Wed Dec 03 15:40:28 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereExecute: Failed to create the stream</p>

<p>[Wed Dec 03 15:40:28 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereHandleRequest: Failed to execute the transaction to ‘wasserverNode01_abc’on host ‘wasserver’; will try another one</p>

<p>[Wed Dec 03 15:40:28 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereWriteRequestReadResponse: Failed to find an app server to handle this request</p>

<p>[Wed Dec 03 15:40:28 2014] 00000dbc 00000e78 - ERROR: ESI: getResponse: failed to get response: rc = 2</p>

<p>[Wed Dec 03 15:40:28 2014] 00000dbc 00000e78 - ERROR: ws_common: websphereHandleRequest: Failed to handle request
```</p>

<p>这段错误的LOG完全给不出有用的信息，只是在说无法建立连接，导致请求处理失败。</p>

<p>奇怪的地方是http没问题但是https就不行。</p>

<h3 id="logihserror-logwasjvm-loghttpswas">2）继续检查其他所有的Log，包括IHS的error log——没有任何错误信息，WAS的JVM log——用https做的访问请求完全没有任何输出，意味着请求完全没有到达WAS应用。</h3>

<h3 id="plugin-config">3）继续怀疑是plugin config文件的问题，但是试过很多更改，全部都是一样的效果。</h3>

<p>怎么办？还是怀疑问题出在plugin的转发过程上。想起来plugin的Log level是可以更改的，我们所设置的leve是ERROR，只有在plugin转发出现ERROR信息的时候才会保存到plugin_cfg.log文件内。现在试着把完整地跟踪信息输出。</p>

<p>更改plugin_cfg.xml： 找到这行配置：<em>LogLevel</em>=“Error”， 把Error改成Trace即可。可以等1分钟自动重新加载plugin配置文件或者直接重启IHS服务立刻生效。</p>

<p>果然发现问题了，在plugin log里有这么一段：</p>

<p>```
[Wed Dec 03 17:17:07 2014] 00001220 000012a4 - TRACE: ws_server_group: lockedServerGroupUseServer: Server wasserver_abc picked, weight 2.</p>

<p>[Wed Dec 03 17:17:07 2014] 00001220 000012a4 - TRACE: ws_common: websphereFindTransport: Finding the transport</p>

<p>[Wed Dec 03 17:17:07 2014] 00001220 000012a4 - DETAIL: ws_common: websphereFindTransport: Setting the transport(case 1): wasserver on port 9444</p>

<p>[Wed Dec 03 17:17:07 2014] 00001220 000012a4 - TRACE: ws_common: websphereExecute: Executing the transaction with the app server reqInfo is OKuseExistingStream=0, client-&gt;stream=00000000</p>

<p>[Wed Dec 03 17:17:07 2014] 00001220 000012a4 - DEBUG: ws_common: websphereGetStream: Getting the stream to the app server</p>

<p>[Wed Dec 03 17:17:07 2014] 00001220 000012a4 - TRACE: ws_transport: transportStreamDequeue: Checking for existing stream from the queue</p>

<p>[Wed Dec 03 17:17:07 2014] 00001220 000012a4 - TRACE: ws_common: websphereGetStream: Have a connect timeout of 5; Setting socket to not block for the connect</p>

<p>[Wed Dec 03 17:17:12 2014] 00001220 000012a4 - TRACE: errno 0</p>

<p>[Wed Dec 03 17:17:12 2014] 00001220 000012a4 - TRACE: RET 0</p>

<p>[Wed Dec 03 17:17:12 2014] 00001220 000012a4 - TRACE: READ SET 0</p>

<p>[Wed Dec 03 17:17:12 2014] 00001220 000012a4 - TRACE: WRITE SET 0</p>

<p>[Wed Dec 03 17:17:12 2014] 00001220 000012a4 - TRACE: EXCEPT SET 0</p>

<p>[Wed Dec 03 17:17:12 2014] 00001220 000012a4 - ERROR: ws_common: websphereGetStream: Connect timeout fired
```</p>

<p>实际上看到这一行：Setting the transport(case 1): wasserver on port 9444 就大概明白了，IHS在进行请求转发的时候使用的不是9081，而是9444，9444是wc_default_secure端口，也就是WAS服务器容器的安全传输端口。而9444端口在IHS和WAS之间并没有打开。</p>

<p>看来在处理https请求的时候，IHS会尝试使用安全端口吧请求转发到WAS。</p>

<p>所以现在的问题变成了如何让IHS利用9081端口而不是9444端口？</p>

<h2 id="section-2">问题解决</h2>

<p>在plugin_cfg.xml配置文件中，有一行关于kdb文件的配置信息，里面写明了所使用的plugin.kdb文件放置的路径。删掉这行配置，或者删掉对应的kdb文件就好了。</p>

<p>KDB文件是IBM的用来存放安全证书的文件，安全证书用来给session加密。下一次当IHS找不到安全证书的时候自然就会退而求其次使用没有安全加密的端口9081了。</p>


  <footer>
    <span class="small">Built in Jekyll for GitHub Pages by <a href="http://twitter.com/#!/michigangraham">@mattgraham</a></span>
  </footer>
  </div>
  <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
  </body>
</html>

